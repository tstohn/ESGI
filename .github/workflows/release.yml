name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            ostag: LINUX-x86_64
            mac_arch: x86_64
          - os: macos-15-intel
            ostag: MACOS-Intel-chip
            mac_arch: x86_64
          - os: macos-14
            ostag: MACOS-Apple-Silicon-chips
            mac_arch: arm64
          - os: windows-2022
            ostag: WINDOWS-x86_64
            mac_arch: x86_64

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # -------- Windows: vcpkg for make install --------
      - name: Install vcpkg (Windows)
        if: matrix.os == 'windows-2022'
        shell: powershell
        run: |
          if (!(Test-Path 'C:\vcpkg')) {
            git clone https://github.com/microsoft/vcpkg C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }

      # -------- Linux/macOS build --------
      - name: Build (Linux/macOS)
        if: matrix.os != 'windows-2022'
        run: |
          set -e
          make clean
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export CFLAGS="-arch ${{ matrix.mac_arch }} -mmacosx-version-min=11.0"
            export CXXFLAGS="$CFLAGS"
            export LDFLAGS="-arch ${{ matrix.mac_arch }}"
          fi
          make install
          make demultiplex count esgi annotate

      # -------- Windows build via MSYS2 --------
      - name: MSYS2 setup (Windows)
        if: matrix.os == 'windows-2022'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            zip
            tar
            coreutils

      - name: Build (Windows)
        if: matrix.os == 'windows-2022'
        shell: msys2 {0}
        env:
          VCPKG_ROOT: /c/vcpkg
        run: |
          set -e
          make clean
          make install
          # annotate not built on Windows, that's fine
          make demultiplex count esgi

      # -------- PACKAGE (all OS: use package.sh) --------
      - name: Package (all OS) — esgi-<VER>-<OSTAG>.tar.gz
        if: matrix.os != 'windows-2022'
        run: |
          set -e
          VER="${GITHUB_REF_NAME#v}"
          chmod +x ./scripts/package.sh
          ./scripts/package.sh "$VER" "${{ matrix.ostag }}"
      - name: Package (Windows) — esgi-<VER>-<OSTAG>.tar.gz
        if: matrix.os == 'windows-2022'
        shell: msys2 {0}
        run: |
          set -e
          VER="${GITHUB_REF_NAME#v}"
          chmod +x ./scripts/package.sh
          ./scripts/package.sh "$VER" "${{ matrix.ostag }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.ostag }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: dist

      - name: Generate checksums
        run: |
          cd dist
          # Only hash the tarballs; ignore any stray files
          sha256sum esgi-*.tar.gz > SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.4.1
        with:
          tag_name: ${{ github.ref_name }}
          overwrite_files: true
          files: |
            dist/esgi-*.tar.gz
            dist/SHA256SUMS.txt
